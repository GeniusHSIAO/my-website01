<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互動賓果計分系統 v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        [v-cloak] { display: none; }
        .grid-cell { aspect-ratio: 1 / 1; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-slate-400 animate-pulse text-lg">遊戲載入中，請稍候...</div>
        </div>
    </div>

    <script type="text/babel">
        // 從全域變數中取得 React 功能
        const { useState, useMemo, useEffect } = React;

        // 建立圖示組件 (解決 lucide-react 在 CDN 環境下容易失效的問題)
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
        };

        const App = () => {
            const [grid, setGrid] = useState(Array(25).fill([]));
            const [history, setHistory] = useState([]);
            const [activeTeam, setActiveTeam] = useState('red');
            const [showResetModal, setShowResetModal] = useState(false);

            const TEAMS = {
                red: { id: 'red', name: '紅組', color: '#ef4444', bgColor: 'bg-red-500', activeClass: 'border-red-400 bg-red-50' },
                blue: { id: 'blue', name: '藍組', color: '#3b82f6', bgColor: 'bg-blue-500', activeClass: 'border-blue-400 bg-blue-50' },
                yellow: { id: 'yellow', name: '黃組', color: '#eab308', bgColor: 'bg-yellow-500', activeClass: 'border-yellow-400 bg-yellow-50' }
            };

            const BINGO_LINES = useMemo(() => {
                const lines = [];
                for (let i = 0; i < 5; i++) lines.push([i * 5, i * 5 + 1, i * 5 + 2, i * 5 + 3, i * 5 + 4]);
                for (let i = 0; i < 5; i++) lines.push([i, i + 5, i + 10, i + 15, i + 20]);
                lines.push([0, 6, 12, 18, 24], [4, 8, 12, 16, 20]);
                return lines;
            }, []);

            const scores = useMemo(() => {
                const results = { red: 0, blue: 0, yellow: 0 };
                Object.keys(TEAMS).forEach(teamId => {
                    let cellPoints = grid.filter(cell => cell.includes(teamId)).length;
                    let bingoPoints = 0;
                    BINGO_LINES.forEach(line => {
                        if (line.every(index => grid[index].includes(teamId))) bingoPoints += 3;
                    });
                    results[teamId] = cellPoints + bingoPoints;
                });
                return results;
            }, [grid]);

            const handleCellClick = (index) => {
                setHistory(prev => [...prev, JSON.parse(JSON.stringify(grid))].slice(-50));
                setGrid(prevGrid => {
                    const newGrid = [...prevGrid];
                    const currentCell = [...newGrid[index]];
                    if (currentCell.includes(activeTeam)) {
                        newGrid[index] = currentCell.filter(t => t !== activeTeam);
                    } else if (currentCell.length < 2) {
                        newGrid[index] = [...currentCell, activeTeam];
                    }
                    return newGrid;
                });
            };

            const handleUndo = () => {
                if (history.length === 0) return;
                setGrid(history[history.length - 1]);
                setHistory(prev => prev.slice(0, -1));
            };

            const getCellStyles = (cellTeams) => {
                if (cellTeams.length === 0) return { backgroundColor: '#ffffff' };
                if (cellTeams.length === 1) return { backgroundColor: TEAMS[cellTeams[0]].color };
                return { background: `linear-gradient(45deg, ${TEAMS[cellTeams[0]].color} 50%, ${TEAMS[cellTeams[1]].color} 50%)` };
            };

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-5xl mx-auto">
                    <header className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                        <div>
                            <h1 className="text-3xl font-bold text-slate-800 flex items-center gap-2">
                                <Icon name="trophy" className="text-yellow-500" size={32} /> 出題者視角 v3
                            </h1>
                            <p className="text-slate-500 mt-1">互動賓果計分：選取隊伍後點擊格子</p>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={handleUndo} disabled={history.length === 0} className={`flex items-center gap-2 px-4 py-2 bg-white border rounded-lg shadow-sm transition-all ${history.length === 0 ? 'opacity-30 cursor-not-allowed' : 'hover:bg-blue-50 text-blue-600'}`}>
                                <Icon name="undo-2" size={18} /> 返回上一步
                            </button>
                            <button onClick={() => setShowResetModal(true)} className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-lg shadow-sm hover:bg-red-50 text-red-600 transition-colors">
                                <Icon name="rotate-ccw" size={18} /> 重置
                            </button>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
                        <div className="lg:col-span-3">
                            <div className="grid grid-cols-5 gap-2 md:gap-4 bg-white p-4 md:p-6 rounded-2xl shadow-xl border border-slate-100">
                                {grid.map((cellTeams, idx) => (
                                    <button key={idx} onClick={() => handleCellClick(idx)} style={getCellStyles(cellTeams)}
                                        className={`grid-cell relative flex items-center justify-center rounded-xl text-xl md:text-3xl font-bold transition-all transform active:scale-95 shadow-sm border-2 ${cellTeams.length > 0 ? 'border-white/30 text-white' : 'border-slate-100 text-slate-300'}`}>
                                        <span className="drop-shadow-md">{idx + 1}</span>
                                        {cellTeams.includes(activeTeam) && <div className="absolute top-1 right-1 w-2 h-2 md:w-3 md:h-3 bg-white rounded-full animate-pulse shadow-sm" />}
                                    </button>
                                ))}
                            </div>
                            
                            <div className="mt-6 bg-blue-50 border border-blue-100 p-4 rounded-xl flex items-start gap-3">
                                <Icon name="info" className="text-blue-500 mt-1" size={20} />
                                <div className="text-sm text-blue-800">
                                    <p className="font-semibold text-base mb-1">使用方式：</p>
                                    <ul className="list-disc list-inside opacity-90 space-y-1">
                                        <li>點選右側<strong>隊伍卡片</strong>切換當前標記組別。</li>
                                        <li>點擊左側格子可進行標記，每格最多標記兩組。</li>
                                        <li>連成一條線（橫、直、斜）額外加 3 分。</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div className="flex flex-col gap-4">
                            <h2 className="text-xl font-bold flex items-center gap-2 text-slate-700 ml-1">
                                <Icon name="users" size={20} /> 隊伍計分
                            </h2>
                            {Object.values(TEAMS).map((team) => (
                                <div key={team.id} onClick={() => setActiveTeam(team.id)}
                                    className={`cursor-pointer p-4 rounded-xl border-2 transition-all flex items-center justify-between ${activeTeam === team.id ? team.activeClass + ' scale-[1.02] shadow-md' : 'border-transparent bg-white hover:bg-slate-100'}`}>
                                    <div className="flex items-center gap-3">
                                        <div className={`w-10 h-10 rounded-lg ${team.bgColor} flex items-center justify-center text-white font-bold shadow-sm`}>{team.name[0]}</div>
                                        <span className={`font-bold ${activeTeam === team.id ? 'text-slate-800' : 'text-slate-400'}`}>{team.name}</span>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-2xl font-black text-slate-800">{scores[team.id]}</div>
                                        <div className="text-[10px] text-slate-400 font-bold uppercase">Points</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {showResetModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
                            <div className="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl animate-in zoom-in-95 duration-200">
                                <div className="w-12 h-12 bg-red-100 rounded-full mb-4 mx-auto flex items-center justify-center text-red-600">
                                    <Icon name="alert-triangle" size={28} />
                                </div>
                                <h3 className="text-xl font-bold text-center mb-2">確定重置遊戲？</h3>
                                <p className="text-slate-500 text-center text-sm mb-6">這將會清空所有格子的標記與分數，此動作無法復原。</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowResetModal(false)} className="flex-1 py-3 border border-slate-200 text-slate-600 font-bold rounded-xl hover:bg-slate-50 transition-colors">取消</button>
                                    <button onClick={() => { setGrid(Array(25).fill([])); setHistory([]); setShowResetModal(false); }} className="flex-1 py-3 bg-red-600 text-white font-bold rounded-xl shadow-lg shadow-red-200 hover:bg-red-700 transition-colors">確認重置</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
